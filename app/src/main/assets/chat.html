<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesor Ingl√©s - Keys con Nombre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #1e3c72;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
        }

        .tab-btn.active {
            background: white;
            color: #1e3c72;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Chat Styles */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 100px;
            /* Space for fixed input controls */
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .message.user .message-content {
            background: #dbeafe;
            color: #1e3c72;
            margin-left: auto;
            max-width: 85%;
        }

        .message.error .message-content {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .language-section {
            margin-bottom: 10px;
        }

        .language-label {
            font-size: 14px;
            color: #888;
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .text-with-audio {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            justify-content: space-between;
        }

        .main-text {
            font-size: 16px;
            color: #333;
            line-height: 1.4;
        }

        .pronunciation-text {
            color: #2b6cb0;
            font-style: italic;
            font-size: 14px;
            margin-top: 2px;
            font-family: 'Georgia', serif;
        }

        .speak-btn {
            background: #e2e8f0;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
            transition: 0.2s;
        }

        .speak-btn:hover {
            background: #cbd5e0;
        }

        .speak-btn.speaking {
            background: #48bb78;
            color: white;
        }

        .speak-word-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
            border-bottom: 1px dotted #999;
            padding: 0 1px;
        }

        .speak-word-btn:hover {
            background: #e2e8f0;
            color: #1e3c72;
        }

        .options-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .options-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .option-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            border-left: 4px solid #1e3c72;
        }

        .option-card:hover {
            transform: translateX(3px);
            border-color: #1e3c72;
            background: #f8fafc;
        }

        .option-english {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .option-spanish {
            font-size: 13px;
            color: #718096;
            font-style: italic;
        }

        .save-phrase-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #cbd5e0;
        }

        .save-phrase-btn.saved {
            color: #f6e05e;
        }

        /* Word Practice Modal */
        .word-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .word-modal-backdrop.active {
            display: flex;
        }

        .word-modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .word-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .word-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #1e3c72;
        }

        .word-modal-close {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .word-btn {
            padding: 8px 12px;
            background: #e2e8f0;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .word-btn.selected {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .word-modal-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .mic-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1e3c72;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .mic-button.recording {
            background: #e53e3e;
            animation: pulse 1s infinite;
        }

        textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
        }

        .send-btn {
            padding: 0 20px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* CONFIG & KEYS STYLES */
        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .api-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-row {
            display: flex;
            gap: 5px;
        }

        .api-row input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        #newKeyName {
            width: 35%;
        }

        #newApiKeyInput {
            flex: 1;
        }

        .add-key-btn {
            padding: 10px 15px;
            background: #2b6cb0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .key-list {
            list-style: none;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
        }

        .key-item:hover {
            background: #edf2f7;
            transform: translateX(2px);
        }

        .key-item.active-key {
            border: 2px solid #48bb78;
            background: #f0fff4;
        }

        .key-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .key-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 14px;
        }

        .key-mask {
            font-family: monospace;
            color: #718096;
            font-size: 12px;
            background: #edf2f7;
            padding: 2px 4px;
            border-radius: 4px;
            width: fit-content;
        }

        .key-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-active {
            background: #48bb78;
            color: white;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);
        }

        .delete-key-btn {
            color: #e53e3e;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            transition: 0.2s;
        }

        .delete-key-btn:hover {
            transform: scale(1.2);
            background: #fee2e2;
            border-radius: 50%;
        }

        /* Practice Tab */
        .practice-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .pc-controls {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .pc-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .pc-record {
            background: #1e3c72;
            color: white;
        }

        .pc-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }

        .pc-feedback.correct {
            background: #c6f6d5;
            color: #22543d;
        }

        .pc-feedback.incorrect {
            background: #fed7d7;
            color: #822727;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .status {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
        }

        .status.connected {
            color: green;
            font-weight: bold;
        }

        .status.error {
            color: #e53e3e;
        }

        /* Practice Mode Styles */
        .practice-mode-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .pm-btn {
            background: #e2e8f0;
            border: 1px solid #cbd5e0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .pm-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
            box-shadow: 0 4px 6px rgba(30, 60, 114, 0.2);
        }

        .pm-btn:hover:not(.active) {
            background: #cbd5e0;
        }

        .hidden-text {
            filter: blur(5px);
            user-select: none;
            opacity: 0.6;
            cursor: pointer;
            transition: filter 0.3s ease;
        }

        .hidden-text:hover {
            opacity: 0.8;
            /* Optional: peek on hover? No, defeat purpose. */
        }

        /* Premium Button Styles for Practice Card */
        .pc-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .pc-btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pc-record {
            background: #ebf8ff;
            color: #2b6cb0;
            border-color: #bee3f8;
        }

        .pc-record:hover {
            background: #bee3f8;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>AI English Teacher (Multi-Key)</h1>
            <div class="tabs">
                <button class="tab-btn active" data-tab="chat">Chat</button>
                <button class="tab-btn" data-tab="practice">Pr√°ctica</button>
                <button class="tab-btn" data-tab="config">Config</button>
            </div>
        </div>

        <div id="chatTab" class="tab-content active">
            <div class="chat-container" id="chatContainer">
                <!-- Mensajes aqu√≠ -->
            </div>
            <div class="input-container">
                <button class="mic-button" id="micBtn" onclick="toggleRecording()">MIC</button>
                <textarea id="userInput" placeholder="Escribe o habla..." disabled></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Enviar</button>
                <button class="send-btn" id="resetBtn" onclick="resetChat()" style="background:#e53e3e; padding:0 15px;"
                    title="Reiniciar conversaci√≥n">üîÑ</button>
            </div>
        </div>

        <div id="practiceTab" class="tab-content">
            <h3 style="margin-bottom:10px; color:#555;">Practicar Frases</h3>
            <div class="practice-mode-bar">
                <button class="pm-btn active" onclick="setPracticeMode('read')">üìñ Leer y Hablar</button>
                <button class="pm-btn" onclick="setPracticeMode('translation')">üá™üá∏ Traducci√≥n</button>
                <button class="pm-btn" onclick="setPracticeMode('listening')">üëÇ Escucha Pura (Playlist)</button>
            </div>
            <div id="listeningControls"
                style="display:none; padding:10px; background:#e2e8f0; border-radius:8px; margin-bottom:10px; text-align:center;">
                <button id="playPauseBtn" onclick="toggleListeningPlayback()"
                    style="padding:8px 20px; background:#1e3c72; color:white; border:none; border-radius:20px; font-weight:bold;">‚ñ∂Ô∏è
                    Reproducir Todo</button>
                <div style="font-size:11px; color:#666; margin-top:5px;">Reproducci√≥n continua infinita (Ingl√©s) - Se
                    guarda tu progreso</div>
            </div>
            <div id="practiceList"></div>
        </div>

        <div id="configTab" class="tab-content">
            <!-- GESTOR DE API KEYS -->
            <div class="config-section">
                <h4>Gesti√≥n de API Keys</h4>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Agrega un nombre y la clave. Haz clic en una
                    para usarla.</p>

                <!-- LOCAL SCANNER UI -->
                <div
                    style="margin-bottom:15px; padding:10px; background:#e6fffa; border:1px solid #b2f5ea; border-radius:8px;">
                    <h5 style="color:#2c7a7b; margin-bottom:5px;">üåê Esc√°ner de Agentes Locales</h5>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="text" id="scanSubnet" placeholder="IP (ej: 192.168.1.50) o Subred (192.168.1)"
                            style="flex:1; padding:5px; border:1px solid #cbd5e0; border-radius:4px;">
                        <input type="number" id="scanPort" value="5000" placeholder="Puerto"
                            style="width:60px; padding:5px; border:1px solid #cbd5e0; border-radius:4px;">
                    </div>
                    <div style="margin-bottom:5px;">
                        <input type="text" id="scanEndpoint" value="/api/agents" placeholder="Endpoint"
                            style="width:100%; padding:5px; border:1px solid #cbd5e0; border-radius:4px;">
                    </div>
                    <button onclick="scanLocalNetwork()"
                        style="width:100%; padding:8px; background:#38b2ac; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üîÑ
                        Escanear / Refrescar</button>
                    <div id="scanStatus" style="font-size:11px; margin-top:5px; color:#666; min-height:15px;"></div>
                    <div id="foundAgentsList" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;">
                    </div>
                </div>

                <div class="api-input-group">
                    <div class="api-row">
                        <input type="text" id="newKeyName" placeholder="Nombre (ej: Personal)">
                        <input type="password" id="newApiKeyInput" placeholder="API Key (AIza...)">
                    </div>
                    <button class="add-key-btn" onclick="addNewApiKey()">Guardar Nueva Key</button>
                </div>

                <ul id="keyListContainer" class="key-list">
                    <!-- Lista generada por JS -->
                </ul>
                <div id="status" class="status"></div>
            </div>

            <div class="config-section">
                <h4>Tema de conversaci√≥n</h4>
                <input type="text" id="topicInput" placeholder="Ej: Negocios, Viajes..."
                    style="width:100%; padding:8px; margin-top:5px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div class="config-section">
                <h4>L√≠mite de Historial</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Cu√°ntos intercambios enviar a la API (1
                    intercambio = tu mensaje + respuesta del profesor)</p>
                <div style="display:flex; gap:10px; align-items:center;">
                    <label>√öltimos <input type="number" id="historyLimit" min="1" max="20" value="3"
                            style="width:60px; padding:5px; border:1px solid #ddd; border-radius:4px; text-align:center;">
                        intercambios</label>
                </div>
            </div>

            <div class="config-section">
                <h4>Modelo de Gemini</h4>
                <p style="font-size:12px; color:#666; margin-bottom:8px;">Selecciona el modelo de IA (todos son
                    gratuitos)</p>
                <select id="geminiModel" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (Recomendado) ‚ö°</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (M√°s inteligente) üß†</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                </select>
            </div>

            <div class="config-section">
                <h4>Configuraci√≥n de Voz</h4>
                <div style="margin-top:10px;">
                    <label>Voz del Profesor (Android):</label>
                    <select id="englishVoice" style="width:100%; margin-bottom:10px; padding:5px;">
                        <option>Default Android Voice</option>
                    </select>
                    <button onclick="openAndroidTtsSettings()"
                        style="width:100%; margin-bottom:10px; padding:8px; background:#4a5568; color:white; border:none; border-radius:4px; cursor:pointer;">‚öôÔ∏è
                        Configurar Voz en Android</button>

                    <div style="margin-top:10px; margin-bottom:10px;">
                        <label>Velocidad: <span id="rateValue">1.0</span></label>
                        <input type="range" id="rateSlider" min="0.01" max="2.0" step="0.05" value="1.0"
                            style="width:100%" oninput="updateRate(this.value)">
                        <div style="font-size:11px; color:#666; margin-top:3px;">0.01 = Ultra lento | 1.0 = Normal | 2.0
                            = R√°pido</div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" id="autoSpeak" checked> <label for="autoSpeak">Reproducir audio
                        autom√°ticamente</label>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                    <input type="checkbox" id="autoSave" checked> <label for="autoSave">Guardar mis respuestas
                        autom√°ticamente</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GESTI√ìN DE ESTADO ---
        let apiKeysList = JSON.parse(localStorage.getItem('geminiApiKeysList')) || [];

        // MIGRACI√ìN
        if (apiKeysList.length > 0 && typeof apiKeysList[0] === 'string') {
            apiKeysList = apiKeysList.map(k => ({ key: k, name: 'Sin Nombre (Antigua)' }));
            localStorage.setItem('geminiApiKeysList', JSON.stringify(apiKeysList));
        }

        let currentApiKey = localStorage.getItem('geminiActiveKey') || '';

        // --- HISTORY PERSISTENCE CHANGE ---
        // Chat history is NOT persisted - starts fresh each session
        // Only practice phrases are saved
        let conversationHistory = [];

        // LOCAL AGENT STATE
        let localAgentConfig = JSON.parse(localStorage.getItem('localAgentConfig')) || null; // { url: 'http://...', name: '...', systemPrompt: '...' }

        let isRecording = false;
        let savedPhrases = JSON.parse(localStorage.getItem('savedPhrases')) || [];
        let conversationTopic = localStorage.getItem('conversationTopic') || '';
        let practiceMode = 'read'; // read, translation, listening

        // Listening Mode State
        let isListeningPlaying = false;
        let listeningIndex = parseInt(localStorage.getItem('listeningProgress')) || 0;

        // --- ANDROID INTEGRATION VARIABLES ---
        let recordingMode = 'chat'; // 'chat' or 'practice'
        let currentPracticeIndex = -1;
        let currentPracticeTarget = '';

        // Migrate old phrases to new mastery structure
        function migratePhrases() {
            let migrated = false;
            savedPhrases = savedPhrases.map(phrase => {
                if (!phrase.mastery) {
                    migrated = true;
                    return {
                        ...phrase,
                        mastery: {
                            read: { order: 0, streak: 0, lastPracticed: null },
                            translation: { order: 0, streak: 0, lastPracticed: null },
                            listening: { order: 0, streak: 0, lastPracticed: null }
                        }
                    };
                }
                return phrase;
            });
            if (migrated) {
                localStorage.setItem('savedPhrases', JSON.stringify(savedPhrases));
                console.log('Migrated phrases to new mastery structure');
            }
        }

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            migratePhrases(); // Migrate old phrases first
            initTabs();
            // loadVoices(); // Android TTS handles voices differently

            // Check Android voice
            if (typeof Android !== 'undefined' && Android.getVoiceName) {
                const vName = Android.getVoiceName('en');
                document.getElementById('englishVoice').innerHTML = `<option>${vName}</option>`;
            }

            renderKeyList();
            renderFoundAgents(); // Show if any saved, though we usually re-scan

            if (currentApiKey) {
                const exists = apiKeysList.some(k => k.key === currentApiKey);
                if (exists) {
                    updateStatus(true);
                    // Always show initial message - chat doesn't persist
                    showInitialMessage();
                } else {
                    currentApiKey = '';
                    localStorage.removeItem('geminiActiveKey');
                    updateStatus(false);
                }
            } else {
                updateStatus(false);
            }

            document.getElementById('topicInput').value = conversationTopic;
            document.getElementById('topicInput').addEventListener('change', (e) => localStorage.setItem('conversationTopic', e.target.value));

            // History Limit Config
            const historyLimitInput = document.getElementById('historyLimit');
            historyLimitInput.value = localStorage.getItem('historyLimit') || '3';
            historyLimitInput.addEventListener('change', (e) => {
                const val = Math.max(1, Math.min(20, parseInt(e.target.value) || 3));
                e.target.value = val;
                localStorage.setItem('historyLimit', val);
            });

            // Gemini Model Selector
            const modelSelector = document.getElementById('geminiModel');
            modelSelector.value = localStorage.getItem('geminiModel') || 'gemini-2.5-flash';
            modelSelector.addEventListener('change', (e) => {
                localStorage.setItem('geminiModel', e.target.value);
            });

            // Config Listeners
            const asC = document.getElementById('autoSave');
            asC.checked = localStorage.getItem('autoSave') !== 'false';
            asC.addEventListener('change', (e) => localStorage.setItem('autoSave', e.target.checked));

            const rateSlider = document.getElementById('rateSlider');
            const savedRate = localStorage.getItem('speechRate') || '1.0';
            rateSlider.value = savedRate;
            document.getElementById('rateValue').textContent = savedRate;

            // Load Scanner Config
            const savedScanner = JSON.parse(localStorage.getItem('scannerConfig')) || {};
            if (savedScanner.subnet) document.getElementById('scanSubnet').value = savedScanner.subnet;
            if (savedScanner.port) document.getElementById('scanPort').value = savedScanner.port;
            if (savedScanner.endpoint) document.getElementById('scanEndpoint').value = savedScanner.endpoint;

            updateControls();
        });

        // --- API KEYS LOGIC ---
        function renderKeyList() {
            const list = document.getElementById('keyListContainer');
            list.innerHTML = '';

            if (apiKeysList.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#999; padding:10px;">No hay Keys. Agrega una arriba.</li>';
                return;
            }

            apiKeysList.forEach((item) => {
                const li = document.createElement('li');
                const isActive = item.key === currentApiKey;
                li.className = `key-item ${isActive ? 'active-key' : ''}`;
                li.onclick = () => selectApiKey(item.key);

                const maskedKey = item.key.length > 10 ? `${item.key.substring(0, 6)}...${item.key.substring(item.key.length - 4)}` : '****';

                li.innerHTML = `
                    <div class="key-info">
                        <span class="key-name">${item.name || 'Sin Nombre'}</span>
                        <span class="key-mask">üîë ${maskedKey}</span>
                    </div>
                    <div class="key-actions">
                        ${isActive ? '<span class="badge badge-active">USANDO</span>' : ''}
                        <button class="delete-key-btn" onclick="deleteApiKey('${item.key}', event)" title="Eliminar Key">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function addNewApiKey() {
            const nameInput = document.getElementById('newKeyName');
            const keyInput = document.getElementById('newApiKeyInput');

            const name = nameInput.value.trim() || 'Key sin nombre';
            const key = keyInput.value.trim();

            if (!key) return alert("La API Key es obligatoria.");
            if (apiKeysList.some(k => k.key === key)) return alert("Esta API Key ya existe en tu lista.");

            apiKeysList.push({ name: name, key: key });
            localStorage.setItem('geminiApiKeysList', JSON.stringify(apiKeysList));

            if (apiKeysList.length === 1) selectApiKey(key);
            else renderKeyList();

            keyInput.value = '';
            nameInput.value = '';
        }

        function selectApiKey(key) {
            currentApiKey = key;
            localStorage.setItem('geminiActiveKey', currentApiKey);
            renderKeyList();
            updateStatus(true);
            updateControls();

            if (conversationHistory.length === 0) showInitialMessage();
        }

        function deleteApiKey(keyToDelete, event) {
            event.stopPropagation();
            if (!confirm("¬øEliminar esta clave?")) return;

            apiKeysList = apiKeysList.filter(k => k.key !== keyToDelete);
            localStorage.setItem('geminiApiKeysList', JSON.stringify(apiKeysList));

            if (currentApiKey === keyToDelete) {
                currentApiKey = '';
                localStorage.removeItem('geminiActiveKey');
                updateStatus(false);
                updateControls();
            }

            renderKeyList();
        }

        function updateStatus(connected) {
            const el = document.getElementById('status');
            if (localAgentConfig) {
                el.textContent = `‚úÖ Local: ${localAgentConfig.name}`;
                el.className = 'status connected';
                return;
            }
            if (connected) {
                const activeKeyObj = apiKeysList.find(k => k.key === currentApiKey);
                const name = activeKeyObj ? activeKeyObj.name : 'Desconocida';
                el.textContent = `‚úÖ Cloud: ${name}`;
                el.className = 'status connected';
            } else {
                el.textContent = '‚ö†Ô∏è Desconectado';
                el.className = 'status error';
            }
        }

        function updateControls() {
            const disabled = !currentApiKey;
            document.getElementById('userInput').disabled = disabled;
            document.getElementById('sendBtn').disabled = disabled;
            document.getElementById('micBtn').disabled = disabled;
            // Reset button should ALWAYS be enabled
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.disabled = false;
        }

        // --- PROMPT & GEMINI ---
        function getCurrentSystemPrompt() {
            const topic = document.getElementById('topicInput').value.trim();
            return `You are an English teacher for Spanish speakers.
            ${topic ? `Topic: "${topic}".` : ''}
            
            CRITICAL INSTRUCTIONS:
            1. Response: Maximum 15 words in English.
            2. Options: Provide EXACTLY ONE (1) suggested reply option.
            3. Pronunciation: MANDATORY - Write how the ENGLISH phrase sounds using Spanish phonetics.
               - This is NOT a translation
               - This is how a Spanish speaker would READ the English words
               - Example: "Water" ‚Üí "Gu√°ter" (not "Agua")
               - Example: "How are you?" ‚Üí "Jau ar iu?" (not "¬øC√≥mo est√°s?")
               - Example: "Thank you" ‚Üí "Zenk iu" (not "Gracias")
            
            JSON STRUCTURE (strict):
            {
              "english": "Your English response",
              "spanish": "Spanish translation of your response",
              "pronunciation": "Phonetic Spanish reading of the ENGLISH phrase",
              "options": [{
                "english": "Suggested English reply",
                "spanish": "Spanish translation of reply",
                "pronunciation": "Phonetic Spanish reading of the ENGLISH reply",
                "word_translations": {"EnglishWord": "SpanishWord"}
              }]
            }
            
            REMEMBER: "pronunciation" is ALWAYS the phonetic Spanish spelling of the ENGLISH text, NEVER the Spanish translation.`;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            if (!currentApiKey && !localAgentConfig) return alert("Configura una API Key o selecciona un Agente Local.");

            addMessage(text, 'user');
            input.value = '';

            conversationHistory.push({ role: 'user', parts: [{ text: text }] });
            // Chat history is NOT saved - only kept in memory for this session

            const loadingId = showLoading();

            // Get history limit from config (default 3 exchanges = 6 messages)
            const historyLimit = parseInt(localStorage.getItem('historyLimit') || '3');
            const messagesToSend = historyLimit * 2; // Each exchange = 2 messages (user + model)
            const historyToSend = conversationHistory.slice(-messagesToSend);

            const systemPrompt = getCurrentSystemPrompt();

            const responseText = await getAiResponse(historyToSend, systemPrompt);

            removeLoading(loadingId);

            // Handle Error String
            if (responseText.startsWith("Error")) {
                showErrorMessage(responseText);
                return;
            }

            try {
                // Try to parse if it looks like JSON, else treat as text
                let aiJson;
                try {
                    aiJson = JSON.parse(responseText);
                } catch (e) {
                    console.log("Response not JSON, wrapping:", responseText);
                    // If unexpected text, wrap it.
                    aiJson = {
                        english: responseText,
                        spanish: "...",
                        pronunciation: "...",
                        options: []
                    };
                }

                conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(aiJson) }] });
                // Chat history is NOT saved - only kept in memory for this session
                addAiMessage(aiJson);

            } catch (e) {
                showErrorMessage("Error procesando respuesta IA");
            }
        }

        async function getAiResponse(history, systemPrompt) {
            if (localAgentConfig) {
                return callLocalAgent(history, systemPrompt);
            } else {
                return callCloudAgent(history, systemPrompt);
            }
        }

        async function callCloudAgent(historyToSend, systemPrompt) {
            try {
                // Get selected model from config (default: gemini-2.5-flash)
                const modelId = localStorage.getItem('geminiModel') || 'gemini-2.5-flash';
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyToSend,
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    if (response.status === 429) return "Error: L√≠mite de cuota excedido.";
                    if (response.status === 400) return "Error: Key inv√°lida.";
                    return `Error API: ${response.status}`;
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                }
                return "Error: Respuesta vac√≠a de Gemini.";
            } catch (e) {
                return "Error de conexi√≥n con Gemini.";
            }
        }

        async function callLocalAgent(historyToSend, systemPrompt) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Conectando con Agente Local...';

            try {
                const messages = historyToSend.map(h => ({ role: h.role, content: h.parts[0].text }));
                messages.unshift({ role: 'system', content: systemPrompt });

                const response = await fetch(localAgentConfig.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: messages,
                        history: historyToSend,
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        stream: false
                    })
                });

                if (!response.ok) throw new Error(`Status ${response.status}`);

                const data = await response.json();
                statusDiv.textContent = '';

                if (data.choices && data.choices[0] && data.choices[0].message) return data.choices[0].message.content;
                if (data.response) return data.response;
                if (data.candidates) return data.candidates[0].content.parts[0].text;

                return JSON.stringify(data);

            } catch (error) {
                statusDiv.textContent = 'Error Local API';
                return "Error Local Agent: " + error.message;
            }
        }

        // --- LOCAL SCANNER LOGIC ---
        async function scanLocalNetwork() {
            const statusEl = document.getElementById('scanStatus');
            const listEl = document.getElementById('foundAgentsList');
            const port = document.getElementById('scanPort').value;
            const endpoint = document.getElementById('scanEndpoint').value;
            let subnetInput = document.getElementById('scanSubnet');

            listEl.innerHTML = '';
            statusEl.textContent = 'Iniciando...';

            // Auto-detect if empty
            if (!subnetInput.value) {
                let localIp = '192.168.1.0';
                if (typeof Android !== 'undefined' && Android.getLocalIpAddress) {
                    const detected = Android.getLocalIpAddress();
                    if (detected && detected !== '0.0.0.0') localIp = detected;
                }
                subnetInput.value = localIp; // Default to full IP to be safe, logic below handles it
            }

            const inputVal = subnetInput.value.trim();
            if (!inputVal) return statusEl.textContent = "‚ö†Ô∏è Ingresa IP o Subred";

            // Save Config
            localStorage.setItem('scannerConfig', JSON.stringify({
                subnet: inputVal,
                port: port,
                endpoint: endpoint
            }));

            // Determine Scan Strategy: Single IP vs Subnet
            // Heuristic: 3 dots = full IP (1.2.3.4), 2 dots or less = subnet (192.168.1)
            // But user might type 192.168.1.50 (4 parts).
            const parts = inputVal.split('.');
            let isSingleIp = (parts.length === 4);

            const promises = [];

            if (isSingleIp) {
                statusEl.textContent = `Verificando ${inputVal}:${port}...`;
                const url = `http://${inputVal}:${port}${endpoint}`;
                promises.push(checkAgentNode(url, inputVal, port));
            } else {
                // Subnet Scan
                const subnet = inputVal.endsWith('.') ? inputVal.slice(0, -1) : inputVal;
                statusEl.textContent = `Escaneando ${subnet}.1-255:${port}...`;
                for (let i = 1; i < 255; i++) {
                    const targetIp = `${subnet}.${i}`;
                    const url = `http://${targetIp}:${port}${endpoint}`;
                    promises.push(checkAgentNode(url, targetIp, port));
                }
            }

            await Promise.allSettled(promises);
            if (listEl.children.length === 0) statusEl.textContent = '‚ùå No se encontraron agentes.';
            else statusEl.textContent = '‚úÖ Escaneo finalizado.';
        }

        async function checkAgentNode(url, ip, port) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 4000);

            try {
                console.log(`Checking: ${url}`);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (response.ok) {
                    console.log(`‚úÖ FOUND at: ${url}`);
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        addAgentToList(data, `http://${ip}:${port}`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è Response ${response.status} from ${url}`);
                }
            } catch (err) {
                // console.log(`‚ùå Failed ${url}: ${err.name}`); // Optional: Uncomment to see all failures
            }
        }

        function addAgentToList(agents, baseUrl) {
            const listEl = document.getElementById('foundAgentsList');
            agents.forEach(agent => {
                const div = document.createElement('div');
                div.style.cssText = "background:white; padding:8px; border:1px solid #38b2ac; border-radius:4px; font-size:12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;";
                div.innerHTML = `
                    <div>
                        <strong>${agent.name}</strong>
                        <div style="color:#666; font-size:10px;">${baseUrl}</div>
                    </div>
                    <button style="border:none; background:none;">‚û°Ô∏è</button>
                `;
                div.onclick = () => selectLocalAgent(agent, baseUrl);
                listEl.appendChild(div);
            });
        }

        function selectLocalAgent(agent, baseUrl) {
            // Assume the chat endpoint is sibling to agents endpoint or standard
            // If user endpoint was /api/agents, we try /api/chat ? 
            // Or just use base + /api/chat. 
            // Let's assume the agent object has 'url' or we construct it.
            // For now: 
            const chatUrl = baseUrl + '/api/chat';

            localAgentConfig = {
                url: chatUrl,
                name: agent.name,
                systemPrompt: agent.systemPrompt,
                model: 'Local Agent'
            };
            localStorage.setItem('localAgentConfig', JSON.stringify(localAgentConfig));

            alert(`‚úÖ Agente "${agent.name}" seleccionado.`);

            document.querySelector('.tab-btn[data-tab="chat"]').click();
            updateStatus(true);
        }

        function renderFoundAgents() { }

        // --- UI UTILS ---
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                    if (btn.dataset.tab === 'practice') renderPractice();
                });
            });
        }

        function addMessage(text, type, silent = false) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<div class="message-content">${text}</div>`;
            document.getElementById('chatContainer').appendChild(div);
            if (!silent) div.scrollIntoView({ behavior: 'smooth' });
        }

        function showErrorMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message error';
            div.innerHTML = `<div class="message-content"><strong>Error:</strong> ${msg}</div>`;
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function addAiMessage(data, silent = false) {
            const div = document.createElement('div');
            div.className = 'message';

            // Safety check for options
            const option = (data.options && data.options.length > 0) ? data.options[0] : { english: '...', spanish: '...', pronunciation: '...' };

            const isMainSaved = '';
            const isOptSaved = '';

            // Storing options temporarily for auto-save lookup
            window.lastOptions = data.options;

            div.innerHTML = `
                <div class="message-content">
                    <div class="language-section">
                        <div class="language-label">Teacher <button class="save-phrase-btn ${isMainSaved}" onclick="toggleSave('${data.english.replace(/'/g, "\\'")}', '${data.spanish.replace(/'/g, "\\'")}', '${option.english.replace(/'/g, "\\'")}', '${option.spanish.replace(/'/g, "\\'")}', this)">‚≠ê</button></div>
                        <div class="text-with-audio">
                            <div><span class="main-text">${wrapWords(data.english)}</span><div class="pronunciation-text">üó£Ô∏è ${data.pronunciation || ''}</div></div>
                            <button class="speak-btn" onclick="speak('${data.english.replace(/'/g, "\\'")}', 'en')">üîä</button>
                            <button class="speak-btn" onclick="openWordPractice('${data.english.replace(/'/g, "\\'")}')">üî§</button>
                        </div>
                        <div style="font-size:13px; color:#666; margin-top:5px; border-top:1px dashed #eee; padding-top:2px;">${data.spanish}</div>
                    </div>
                    ${data.options && data.options.length > 0 ? `
                    <div class="options-container">
                        <div class="options-title">Tu respuesta sugerida:</div>
                        <div class="option-card" onclick="setInput('${option.english.replace(/'/g, "\\'")}')">
                            <div class="option-english">${wrapWords(option.english)} <button class="save-phrase-btn ${isOptSaved}" onclick="event.stopPropagation(); toggleSave('${data.english.replace(/'/g, "\\'")}', '${data.spanish.replace(/'/g, "\\'")}', '${option.english.replace(/'/g, "\\'")}', '${option.spanish.replace(/'/g, "\\'")}', this)">‚≠ê</button></div>
                            <div class="pronunciation-text" style="font-size:13px; margin-bottom:4px;">üó£Ô∏è ${option.pronunciation || ''}</div>
                            <div class="option-spanish">${option.spanish}</div>
                            <button class="speak-btn" style="margin-top:5px;" onclick="event.stopPropagation(); speak('${option.english.replace(/'/g, "\\'")}', 'en')">üîä Escuchar</button>
                            <button class="speak-btn" style="margin-top:5px;" onclick="event.stopPropagation(); openWordPractice('${option.english.replace(/'/g, "\\'")}')">üî§ Palabras</button>
                        </div>
                    </div>` : ''}
                </div>
            `;
            document.getElementById('chatContainer').appendChild(div);
            if (!silent) div.scrollIntoView({ behavior: 'smooth' });

            // Auto Audio
            if (!silent && document.getElementById('autoSpeak').checked) speak(data.english, 'en');

            // --- AUTO SAVE TO PRACTICE (Teacher + Option) ---
            // Only auto-save if this is a NEW message (not silent render)
            const autoSaveEnabled = document.getElementById('autoSave') && document.getElementById('autoSave').checked;

            if (!silent && autoSaveEnabled && data.options && data.options.length > 0) {
                const tEn = data.english;
                const tEs = data.spanish;
                const tPron = data.pronunciation || '';
                const sEn = option.english;
                const sEs = option.spanish;
                const sPron = option.pronunciation || '';

                // Check if already saved
                const exists = savedPhrases.some(p =>
                    p.teacher && p.teacher.english === tEn &&
                    p.student && p.student.english === sEn
                );

                if (!exists) {
                    console.log('Auto-saving to practice:', { teacher: tEn, student: sEn });
                    savedPhrases.push({
                        teacher: { english: tEn, spanish: tEs, pronunciation: tPron },
                        student: { english: sEn, spanish: sEs, pronunciation: sPron },
                        mastery: {
                            read: { order: 0, streak: 0, lastPracticed: null },
                            translation: { order: 0, streak: 0, lastPracticed: null },
                            listening: { order: 0, streak: 0, lastPracticed: null }
                        }
                    });
                    localStorage.setItem('savedPhrases', JSON.stringify(savedPhrases));
                    console.log('Saved! Total phrases:', savedPhrases.length);

                    // Update practice tab if it's active
                    if (document.getElementById('practiceTab').classList.contains('active')) {
                        renderPractice();
                    }
                } else {
                    console.log('Phrase already exists in practice, skipping');
                }
            }
        }

        // saveChatHistory function removed - chat is not persisted

        function renderHistory() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = ''; // Clear to prevent dupes/mess

            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage(msg.parts[0].text, 'user', true);
                } else if (msg.role === 'model') {
                    const rawText = msg.parts[0].text;
                    try {
                        const data = JSON.parse(rawText);
                        addAiMessage(data, true); // Silent render
                    } catch (e) {
                        console.error('Error parsing saved history item', e);
                        // Fallback: show raw text so at least it appears
                        addMessage(rawText, 'model error', true);
                    }
                }
            });

            // Scroll to bottom once
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function setPracticeMode(mode) {
            practiceMode = mode;
            document.querySelectorAll('.pm-btn').forEach(b => b.classList.remove('active'));
            const map = { 'read': 0, 'translation': 1, 'listening': 2 };
            document.querySelectorAll('.pm-btn')[map[mode]].classList.add('active');

            // Show/Hide Controls
            document.getElementById('listeningControls').style.display = (mode === 'listening') ? 'block' : 'none';
            if (mode !== 'listening' && isListeningPlaying) toggleListeningPlayback(); // Stop if leaving mode

            renderPractice();
        }

        function showInitialMessage() {
            addAiMessage({
                english: "Hi! Select a key and let's talk.", spanish: "Hola, selecciona una key y hablemos.", pronunciation: "Jai! Select a ki and lets tok.",
                options: [{ english: "Hello, I am ready.", spanish: "Hola, estoy listo.", pronunciation: "Jelou, ai am redi." }]
            });
        }

        function setInput(text) {
            document.getElementById('userInput').value = text;

            // Auto Save Logic
            if (document.getElementById('autoSave').checked && window.lastOptions) {
                // Find the option object that matches the selected english text
                const opt = window.lastOptions.find(o => o.english === text);
                if (opt) {
                    // Check if already saved
                    if (!savedPhrases.some(p => p.english === opt.english)) {
                        // Mock a button element for toggleSave as it expects one to toggle classes, 
                        // but we just want to save data here.
                        const mockBtn = { classList: { add: () => { }, remove: () => { } } };
                        toggleSave(opt.english, opt.spanish, mockBtn);
                        renderPractice(); // Update UI
                    }
                }
            }

            sendMessage();
        }

        // Override the onclick in HTML for options
        // We will modify addAiMessage above to pass spanish to setInput
        // Wait, I can't modify the big block easily with multi_replace without matching exact content.
        // I will just add logic in sendMessage to check if the message matches an option?
        // Simpler: Just rely on manual saving OR modified option-card click.

        // Let's modify the setInput signature usage in addAiMessage via a separate chunk? 
        // No, I'll allow the user to save manually, OR 
        // I will modify `setInput` to just take the text, and I will search for it in the last AI options.

        function autoSaveIfNeeded(text) {
            if (document.getElementById('autoSave').checked) {
                // Scan last message options
                const lastAiMsg = conversationHistory.slice().reverse().find(m => m.role === 'model');
                if (lastAiMsg) {
                    // We don't have the parsed JSON easily unless we stored it. 
                    // But we can scan the DOM? No.
                    // Let's just say: explicit "save" is better, but user asked for "guardar las respuestas".
                    // Maybe they mean "Save the responses I CHOOSE".
                    // I will implement a global check in `sendMessage`.
                }
            }
        }

        function showLoading() {
            const id = Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = 'message';
            div.innerHTML = '<div class="message-content" style="color:#888;">Escribiendo...</div>';
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            return id;
        }
        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }

        // --- AUDIO, VOZ, RECONOCIMIENTO (ANDROID NATIVE) ---

        function speak(text, lang) {
            if (typeof Android !== 'undefined' && Android.speak) {
                const rate = parseFloat(localStorage.getItem('speechRate') || '1.0');
                Android.speak(text, lang, rate, 1.0);
            } else {
                console.log("Android TTS not available, fallback to browser");
                // Optional fallback
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang === 'en' ? 'en-US' : 'es-ES';
                speechSynthesis.speak(u);
            }
        }

        // Removed explicit initRecognition because Android manages it

        function toggleRecording() {
            if (typeof Android !== 'undefined' && Android.startListening) {
                if (isRecording) {
                    Android.stopListening();
                } else {
                    recordingMode = 'chat';
                    Android.startListening('en');
                    // UI update happens in callback
                }
            } else {
                alert("Voice input only available in Android App");
            }
        }

        // --- ANDROID CALLBACKS ---
        function onAndroidSpeechStarted() {
            isRecording = true;
            document.getElementById('micBtn').classList.add('recording');
        }

        function onAndroidSpeechResult(text) {
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');

            if (recordingMode === 'chat') {
                document.getElementById('userInput').value = text;
                // Auto send after delay
                setTimeout(sendMessage, 500);
            } else if (recordingMode === 'practice') {
                verifyPractice(text);
            }
        }

        function onAndroidSpeechError(error) {
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');

            if (recordingMode === 'practice' && currentPracticeIndex >= 0) {
                const fb = document.getElementById(`feedback-${currentPracticeIndex}`);
                if (fb) { fb.style.display = 'block'; fb.textContent = "Error: " + error; fb.className = 'pc-feedback incorrect'; }
            } else {
                document.getElementById('userInput').placeholder = "Error: " + error;
            }
        }



        function onAndroidTtsStart() { /* Optional UI sync */ }

        function onAndroidTtsEnd() {
            // If in Listening Mode and Playing, go next
            // Important: We must ensure we are definitely in the playing state.
            if (practiceMode === 'listening' && isListeningPlaying) {
                // Short delay to separate phrases
                setTimeout(() => {
                    // Double check state after delay
                    if (!isListeningPlaying || practiceMode !== 'listening') return;

                    listeningIndex++;
                    if (listeningIndex >= savedPhrases.length) listeningIndex = 0; // Infinite Loop
                    localStorage.setItem('listeningProgress', listeningIndex);
                    playListeningItem(listeningIndex);
                }, 1500); // 1.5s delay
            }
        }

        // --- LISTENING PLAYER LOGIC ---
        function toggleListeningPlayback() {
            if (savedPhrases.length === 0) return alert("No hay frases para reproducir.");

            const btn = document.getElementById('playPauseBtn');
            isListeningPlaying = !isListeningPlaying;

            if (isListeningPlaying) {
                btn.textContent = "‚è∏Ô∏è Pausar";
                // Validate index
                if (listeningIndex >= savedPhrases.length) listeningIndex = 0;
                playListeningItem(listeningIndex);
            } else {
                btn.textContent = "‚ñ∂Ô∏è Reproducir Todo";
                // We don't explicitly stop TTS here because Android.stop() might cut current sentence, 
                // but prompt won't trigger next thanks to flag check in onAndroidTtsEnd
            }
        }

        function playListeningItem(index) {
            if (!savedPhrases || savedPhrases.length === 0) return;
            if (index >= savedPhrases.length) index = 0; // Wrap around safety
            listeningIndex = index; // Ensure global sync

            // Update UI highlight FIRST
            renderPractice();

            // Scroll to item
            setTimeout(() => {
                const el = document.getElementById(`phrase-${index}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);

            // Speak English
            speak(savedPhrases[index].english, 'en');
        }

        // --- EXTRA UTILS ---
        function wrapWords(text) { return text.split(' ').map(w => `<button class="speak-word-btn" onclick="event.stopPropagation(); speak('${w.replace(/[^a-zA-Z]/g, "")}', 'en')">${w}</button>`).join(' '); }

        function updateRate(val) {
            document.getElementById('rateValue').textContent = val;
            localStorage.setItem('speechRate', val);
        }

        function toggleSave(tEn, tEs, sEn, sEs, btn) {
            // Check if this EXACT pair is saved or if we are saving just one?
            // User requested "save both". We treat the pair (Teacher + Student) as the item.
            // Key uniqueness: Teacher English + Student English

            const idx = savedPhrases.findIndex(p => p.teacher && p.teacher.english === tEn && p.student && p.student.english === sEn);

            if (idx >= 0) {
                savedPhrases.splice(idx, 1);
                if (btn) btn.classList.remove('saved');
            } else {
                savedPhrases.push({
                    teacher: { english: tEn, spanish: tEs },
                    student: { english: sEn, spanish: sEs }
                });
                if (btn) btn.classList.add('saved');
            }
            localStorage.setItem('savedPhrases', JSON.stringify(savedPhrases));
        }

        function renderPractice() {
            const list = document.getElementById('practiceList'); list.innerHTML = '';
            if (savedPhrases.length === 0) return list.innerHTML = '<p style="text-align:center; color:#999;">No hay frases guardadas.</p>';

            // Sort by current practice mode's order (lower order first)
            const modeKey = practiceMode === 'read' ? 'read' : practiceMode === 'translation' ? 'translation' : 'listening';
            const sortedPhrases = [...savedPhrases].sort((a, b) => {
                const orderA = a.mastery?.[modeKey]?.order || 0;
                const orderB = b.mastery?.[modeKey]?.order || 0;
                return orderA - orderB;
            });

            sortedPhrases.forEach((phrase, i) => {
                const div = document.createElement('div');
                div.className = 'practice-card';
                div.id = `phrase-${i}`;

                // Backwards compatibility for old format { english, spanish }
                const teacherObj = phrase.teacher || { english: phrase.english, spanish: phrase.spanish };
                const studentObj = phrase.student || null;

                // Highlight if playing
                if (practiceMode === 'listening' && i === listeningIndex) {
                    div.style.border = "2px solid #1e3c72";
                    div.style.background = "#e6fffa";
                }

                // Mode Visibility Logic
                let engClass = '', spaClass = '';
                if (practiceMode === 'translation') spaClass = 'hidden-text';
                else if (practiceMode === 'listening') { engClass = 'hidden-text'; spaClass = 'hidden-text'; }

                // Progress Indicators
                const mastery = phrase.mastery || {
                    read: { order: 0, streak: 0 },
                    translation: { order: 0, streak: 0 },
                    listening: { order: 0, streak: 0 }
                };

                const getStars = (order) => '‚≠ê'.repeat(Math.min(order, 5));
                const getColor = (order) => order === 0 ? '#e53e3e' : order < 3 ? '#f6ad55' : '#48bb78';

                const progressHtml = `
                    <div style="display:flex; gap:10px; margin-bottom:8px; font-size:11px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <div style="color:${getColor(mastery.read.order)};">üìñ ${getStars(mastery.read.order)} (${mastery.read.streak}/3)</div>
                        <div style="color:${getColor(mastery.translation.order)};">üìù ${getStars(mastery.translation.order)} (${mastery.translation.streak}/3)</div>
                        <div style="color:${getColor(mastery.listening.order)};">üëÇ ${getStars(mastery.listening.order)} (${mastery.listening.streak}/3)</div>
                    </div>
                `;

                let contentHtml = progressHtml;

                // Teacher Part
                contentHtml += `
                    <div style="margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:8px;">
                        <div style="font-size:11px; color:#1e3c72; font-weight:bold; text-transform:uppercase;">Teacher</div>
                        <div class="${engClass}" style="color:#555; font-weight:500;">${teacherObj.english}</div>
                        ${teacherObj.pronunciation ? `<div class="pronunciation-text" style="font-size:12px; margin-top:2px;">üó£Ô∏è ${teacherObj.pronunciation}</div>` : ''}
                        <div class="${spaClass}" style="font-size:12px; color:#888; font-style:italic; margin-top:2px;">${teacherObj.spanish}</div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="pc-btn" style="font-size:11px; padding:4px 8px;" onclick="speak('${teacherObj.english.replace(/'/g, "\\'")}', 'en')">üîä Escuchar</button>
                            <button class="pc-btn pc-record" style="font-size:11px; padding:4px 8px;" onclick="practicePhrase('${teacherObj.english.replace(/'/g, "\\'")}', ${i}, 'teacher')">üé§ Practicar</button>
                            <button class="pc-btn" style="font-size:11px; padding:4px 8px;" onclick="openWordPractice('${teacherObj.english.replace(/'/g, "\\'")}')">üî§ Palabras</button>
                        </div>
                    </div>
                `;

                // Student Part
                if (studentObj) {
                    contentHtml += `
                        <div style="margin-bottom:8px;">
                             <div style="font-size:11px; color:#2b6cb0; font-weight:bold; text-transform:uppercase;">You (Respuesta Sugerida)</div>
                             <div style="font-weight:bold;" class="${engClass}">${studentObj.english}</div>
                             ${studentObj.pronunciation ? `<div class="pronunciation-text" style="font-size:12px; margin-top:2px;">üó£Ô∏è ${studentObj.pronunciation}</div>` : ''}
                             <div style="color:#666; font-style:italic; margin-top:2px;" class="${spaClass}">${studentObj.spanish}</div>
                             <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="pc-btn" style="font-size:11px; padding:4px 8px;" onclick="speak('${studentObj.english.replace(/'/g, "\\'")}', 'en')">üîä Escuchar</button>
                                <button class="pc-btn pc-record" style="font-size:11px; padding:4px 8px;" onclick="practicePhrase('${studentObj.english.replace(/'/g, "\\'")}', ${i}, 'student')">üé§ Practicar</button>
                                <button class="pc-btn" style="font-size:11px; padding:4px 8px;" onclick="openWordPractice('${studentObj.english.replace(/'/g, "\\'")}')">üî§ Palabras</button>
                             </div>
                        </div>
                    `;
                }

                // Global Controls
                const controlsHtml = `
                    <div class="pc-controls" style="margin-top:10px; border-top:1px solid #eee; padding-top:8px;">
                        ${(practiceMode !== 'read') ? `<button class="pc-btn btn-toggle-visibility">üëÅÔ∏è Ver Todo</button>` : ''}
                        <button class="pc-btn btn-delete-phrase" data-index="${i}" style="color:red; margin-left:auto;">üóëÔ∏è Eliminar</button>
                    </div>
                    <div id="feedback-${i}" class="pc-feedback"></div>`;

                div.innerHTML = contentHtml + controlsHtml;

                // Add event listeners
                const deleteBtn = div.querySelector('.btn-delete-phrase');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(e.target.getAttribute('data-index'));
                        deletePhrase(index);
                    });
                }

                const toggleBtn = div.querySelector('.btn-toggle-visibility');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => toggleVisibility(toggleBtn));
                }

                list.appendChild(div);
            });
        }

        function deletePhrase(i) {
            console.log('deletePhrase called with index:', i);
            console.log('Deleting phrase at index:', i, 'Total before:', savedPhrases.length);
            savedPhrases.splice(i, 1);
            localStorage.setItem('savedPhrases', JSON.stringify(savedPhrases));
            console.log('Phrase deleted. Remaining:', savedPhrases.length);
            renderPractice();
        }

        // Redefine toggleVisibility correctly to handle multiple hidden elements
        window.toggleVisibility = function (btn) {
            const card = btn.parentElement.parentElement;
            // distinct marker class 'was-hidden' is needed if we want to re-hide properly
            // simple approach: look for hidden-text, if found reveal. If none, re-hide 'marked' ones.
            // But we didn't mark them in renderPractice. 
            // Better: Just toggle a class on the card 'revealed' and use CSS? 
            // Or just check if we have ANY hidden-text currently.

            const hidden = card.querySelectorAll('.hidden-text');
            if (hidden.length > 0) {
                hidden.forEach(el => {
                    el.classList.remove('hidden-text');
                    el.classList.add('was-hidden');
                });
                btn.textContent = 'üëÅÔ∏è Ocultar';
            } else {
                // hide back the ones that were hidden
                const wasHidden = card.querySelectorAll('.was-hidden');
                if (wasHidden.length > 0) {
                    wasHidden.forEach(el => {
                        el.classList.add('hidden-text');
                        el.classList.remove('was-hidden');
                    });
                    btn.textContent = 'üëÅÔ∏è Ver';
                }
            }
        }

        function practicePhrase(target, i, type = 'student') {
            if (typeof Android !== 'undefined') {
                recordingMode = 'practice';
                currentPracticeIndex = i;
                currentPracticeTarget = target;

                const fb = document.getElementById(`feedback-${i}`);
                fb.style.display = 'block';
                fb.textContent = `Escuchando (${type === 'teacher' ? 'Teacher' : 'Tu respuesta'})...`;
                fb.className = 'pc-feedback';

                Android.startListening('en');
            } else {
                alert("Practice mode needs Android App.");
            }
        }

        function openAndroidTtsSettings() {
            if (typeof Android !== "undefined" && Android.openTtsSettings) {
                Android.openTtsSettings();
            } else {
                alert("Funci√≥n exclusiva de la App Android");
            }
        }

        function verifyPractice(spokenText) {
            const spk = spokenText.toLowerCase();
            const tgt = currentPracticeTarget.toLowerCase().replace(/[.,!?]/g, '');
            const ok = spk === tgt || spk.split(' ').filter(w => tgt.includes(w)).length / tgt.split(' ').length > 0.6;

            const fb = document.getElementById(`feedback-${currentPracticeIndex}`);
            if (fb) {
                fb.innerHTML = `Dijiste: "<b>${spk}</b>"<br>${ok ? '‚úÖ Bien' : '‚ö†Ô∏è Intenta'}`;
                fb.className = `pc-feedback ${ok ? 'correct' : 'incorrect'}`;
            }
            recordingMode = 'chat'; // Reset
        }

        function resetChat() {
            if (!confirm('¬øReiniciar la conversaci√≥n? (Las frases guardadas en Pr√°ctica NO se borrar√°n)')) return;

            // Clear conversation history (only in memory)
            conversationHistory.length = 0;

            // Clear chat container
            const container = document.getElementById('chatContainer');
            if (container) {
                container.innerHTML = '';
            }

            // Show initial message
            if (currentApiKey || localAgentConfig) {
                showInitialMessage();
            }
        }

        // ===== WORD PRACTICE MODULE =====
        let currentPhraseWords = [];

        function openWordPractice(phrase) {
            if (!phrase || !phrase.trim()) return;

            // Split phrase into words (remove punctuation)
            currentPhraseWords = phrase.trim().split(/\s+/).map(word => ({
                text: word.replace(/[.,!?;:]/g, ''),
                original: word,
                selected: false
            }));

            // Render word buttons
            const wordGrid = document.getElementById('wordGrid');
            wordGrid.innerHTML = '';

            currentPhraseWords.forEach((wordObj, index) => {
                const btn = document.createElement('button');
                btn.className = 'word-btn';
                btn.textContent = wordObj.original;
                btn.onclick = () => toggleWordSelection(index);
                wordGrid.appendChild(btn);
            });

            // Show modal
            document.getElementById('wordModalBackdrop').classList.add('active');
        }

        function closeWordPractice() {
            document.getElementById('wordModalBackdrop').classList.remove('active');
            currentPhraseWords = [];
        }

        function toggleWordSelection(index) {
            currentPhraseWords[index].selected = !currentPhraseWords[index].selected;
            const buttons = document.querySelectorAll('.word-btn');
            if (buttons[index]) {
                buttons[index].classList.toggle('selected');
            }
        }

        function selectAllWords() {
            currentPhraseWords.forEach(w => w.selected = true);
            document.querySelectorAll('.word-btn').forEach(btn => btn.classList.add('selected'));
        }

        function clearWordSelection() {
            currentPhraseWords.forEach(w => w.selected = false);
            document.querySelectorAll('.word-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function playSelectedWords() {
            const selectedWords = currentPhraseWords
                .filter(w => w.selected)
                .map(w => w.original)  // Use original with punctuation
                .join(' ');

            if (selectedWords.trim()) {
                speak(selectedWords, 'en');
            } else {
                alert('Selecciona al menos una palabra');
            }
        }
    </script>

    <!-- Word Practice Modal -->
    <div id="wordModalBackdrop" class="word-modal-backdrop">
        <div class="word-modal">
            <div class="word-modal-header">
                <div class="word-modal-title">üî§ Selecciona Palabras</div>
                <button class="word-modal-close" onclick="closeWordPractice()">√ó</button>
            </div>
            <div id="wordGrid" class="word-grid"></div>
            <div class="word-modal-controls">
                <button class="pc-btn" onclick="selectAllWords()">‚úì Todas</button>
                <button class="pc-btn" onclick="clearWordSelection()">‚úó Ninguna</button>
                <button class="pc-btn pc-record" onclick="playSelectedWords()">üîä Reproducir</button>
            </div>
        </div>
    </div>
</body>

</html>